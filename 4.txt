
CREATE OR REPLACE PROCEDURE AVGMARKS IS
  CURSOR C_IAMARKS IS
    SELECT USN, SUBCODE, TEST1, TEST2, TEST3
    FROM IAMARKS
    WHERE FINALIA IS NULL
    FOR UPDATE;
  
  v_test1 IAMARKS.TEST1%TYPE;
  v_test2 IAMARKS.TEST2%TYPE;
  v_test3 IAMARKS.TEST3%TYPE;
  v_finalia IAMARKS.FINALIA%TYPE;

BEGIN
  FOR rec IN C_IAMARKS LOOP
    -- Assign test scores to variables
    v_test1 := rec.TEST1;
    v_test2 := rec.TEST2;
    v_test3 := rec.TEST3;
    
    -- Calculate the best two test marks
    IF v_test1 >= v_test2 AND v_test1 >= v_test3 THEN
      v_finalia := (v_test1 + GREATEST(v_test2, v_test3)) / 2;
    ELSIF v_test2 >= v_test1 AND v_test2 >= v_test3 THEN
      v_finalia := (v_test2 + GREATEST(v_test1, v_test3)) / 2;
    ELSE
      v_finalia := (v_test3 + GREATEST(v_test1, v_test2)) / 2;
    END IF;
    
    -- Update IAMARKS table with FinalIA
    UPDATE IAMARKS
    SET FINALIA = v_finalia
    WHERE CURRENT OF C_IAMARKS;
  END LOOP;

  COMMIT;
END AVGMARKS;


BEGIN AVGMARKS;
END


SELECT * FROM IAMARKS;